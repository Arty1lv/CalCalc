<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Food Plan MVP v15</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:14px;background:#f6f7fb;color:#111}
    .top{background:#2f6fed;color:#fff;border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .pill{background:#fff;border-radius:12px;padding:10px 12px;box-shadow:0 2px 10px rgba(0,0,0,.08);flex:1 1 140px;color:#111}
    .pill.clickable{cursor:pointer;user-select:none}
    .muted{color:#666;font-size:13px}
    .mutedOnBlue{color:#dbe7ff;font-size:13px}
    .big{font-size:22px;font-weight:900}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .tabbtn{border:0;background:#fff;padding:10px 12px;border-radius:999px;box-shadow:0 2px 10px rgba(0,0,0,.08);cursor:pointer}
    .tabbtn.active{background:#111;color:#fff}
    .tab{display:none}
    .tab.active{display:block}
    .tabHeader{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin:6px 0 10px}
    .tabTitle{font-weight:900}
    .btn{border:0;background:#19a34a;color:#fff;padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn.secondary{background:#6b7280}
    .btn.danger{background:#dc2626}
    .btn.tiny{padding:6px 10px;border-radius:10px;font-size:14px}
    .card{background:#fff;border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 2px 10px rgba(0,0,0,.08);border:2px solid transparent}
    .kcal{font-weight:900;color:#19a34a;white-space:nowrap}
    input,textarea,select{width:100%;box-sizing:border-box;padding:10px;border-radius:10px;border:1px solid #ddd;font-size:16px}
    textarea{min-height:90px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:680px){.grid2{grid-template-columns:1fr}}
    .status{margin-top:10px;font-size:13px;opacity:.95;min-height:18px}
    .todayBox{background:#fff;border-radius:14px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    .itemRow{display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-bottom:1px solid #eee;align-items:center}
    .itemRow:last-child{border-bottom:0}
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:14px;z-index:999}
    .modal{background:#fff;border-radius:14px;max-width:720px;width:100%;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,.35)}
    .modal h3{margin:0 0 10px}
    .modal .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;justify-content:flex-end}
    .modal .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:680px){.modal .row2{grid-template-columns:1fr}}
    .hidden{display:none !important}
    .fullBar{background:rgba(255,255,255,.25);border-radius:999px;height:10px;overflow:hidden;margin-top:10px}
    .fullBar > div{height:10px;width:0;background:#fff;border-radius:999px}
    .mealCardHead{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .mealCardActions{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap;margin-top:8px}
    .mealMeta{margin-top:6px}
    .todayToggleRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .scanVideo{width:100%;border-radius:14px;background:#000;aspect-ratio:16/9;object-fit:cover}
    .scanOverlay{position:relative}
    .scanHint{position:absolute;left:10px;right:10px;bottom:10px;background:rgba(0,0,0,.55);color:#fff;border-radius:10px;padding:8px 10px;font-size:13px}
  </style>
</head>
<body>
  <div class="top">
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap">
      <div>
        <div style="font-size:18px;font-weight:900" id="appTitle">Food Plan</div>
        <div class="mutedOnBlue" style="margin-top:4px">
          <span id="uiDate"></span> <span id="uiDebugTag"></span>
        </div>
      </div>
    </div>

    <div class="fullBar"><div id="limitBar"></div></div>

    <div class="row" style="margin-top:12px">
      <div class="pill">
        <div class="muted">Съедено</div>
        <div class="big" id="todayEat">0</div>
        <div class="muted">ккал</div>
      </div>
      <div class="pill">
        <div class="muted">Сожжено (упр.)</div>
        <div class="big" id="todayBurn">0</div>
        <div class="muted">ккал</div>
        <div class="muted" id="bmrInfo" style="margin-top:6px"></div>
      </div>
      <div class="pill clickable" id="netTile" title="Нажми для смены режима">
        <div class="muted" id="nettoTitle">Нетто</div>
        <div class="big" id="todayNet">0</div>
        <div class="muted" id="nettoLabel"></div>
      </div>
      <div class="pill">
        <div class="muted">Вес</div>
        <input id="weight" type="number" step="0.1" placeholder="55.0"/>
      </div>
      <div class="pill">
        <div class="muted">Шаги</div>
        <input id="steps" type="number" placeholder="6000"/>
      </div>
    </div>

    <div class="status" id="status"></div>
  </div>

  <div class="tabs">
    <button class="tabbtn active" data-tab="breakfast">Завтрак</button>
    <button class="tabbtn" data-tab="lunch">Обед</button>
    <button class="tabbtn" data-tab="dinner">Ужин</button>
    <button class="tabbtn" data-tab="treat">Вкусняшки</button>
    <button class="tabbtn" data-tab="snacks">Перекусы</button>
    <button class="tabbtn" data-tab="activities">Занятия</button>
    <button class="tabbtn" data-tab="barcode">Штрихкод</button>
    <button class="tabbtn" data-tab="log">Лог</button>
    <button class="tabbtn" data-tab="settings">Настройки</button>
    <button class="tabbtn" data-tab="data">Данные</button>
  </div>

  <!-- Food tabs -->
  <div id="breakfast" class="tab active">
    <div class="tabHeader">
      <div class="tabTitle">Завтрак</div>
      <div class="todayToggleRow">
        <button class="btn secondary" data-toggle-today="breakfast">Сегодня</button>
        <button class="btn secondary" data-add-meal="breakfast">Добавить</button>
      </div>
    </div>
    <div class="grid2" id="breakfastGrid">
      <div><div id="breakfastList"></div></div>
      <div class="todayBox" id="breakfastTodayCol">
        <div style="font-weight:900">Сегодня</div>
        <div id="todayBreakfastList" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <div id="lunch" class="tab">
    <div class="tabHeader">
      <div class="tabTitle">Обед</div>
      <div class="todayToggleRow">
        <button class="btn secondary" data-toggle-today="lunch">Сегодня</button>
        <button class="btn secondary" data-add-meal="lunch">Добавить</button>
      </div>
    </div>
    <div class="grid2" id="lunchGrid">
      <div><div id="lunchList"></div></div>
      <div class="todayBox" id="lunchTodayCol">
        <div style="font-weight:900">Сегодня</div>
        <div id="todayLunchList" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <div id="dinner" class="tab">
    <div class="tabHeader">
      <div class="tabTitle">Ужин</div>
      <div class="todayToggleRow">
        <button class="btn secondary" data-toggle-today="dinner">Сегодня</button>
        <button class="btn secondary" data-add-meal="dinner">Добавить</button>
      </div>
    </div>
    <div class="grid2" id="dinnerGrid">
      <div><div id="dinnerList"></div></div>
      <div class="todayBox" id="dinnerTodayCol">
        <div style="font-weight:900">Сегодня</div>
        <div id="todayDinnerList" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <div id="treat" class="tab">
    <div class="tabHeader">
      <div class="tabTitle">Вкусняшки</div>
      <div class="todayToggleRow">
        <button class="btn secondary" data-toggle-today="treat">Сегодня</button>
        <button class="btn secondary" data-add-meal="treat">Добавить</button>
      </div>
    </div>
    <div class="grid2" id="treatGrid">
      <div><div id="treatList"></div></div>
      <div class="todayBox" id="treatTodayCol">
        <div style="font-weight:900">Сегодня</div>
        <div id="todayTreatList" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <div id="snacks" class="tab">
    <div class="tabHeader">
      <div class="tabTitle">Перекусы</div>
      <div class="todayToggleRow">
        <button class="btn secondary" data-toggle-today="snacks">Сегодня</button>
        <button class="btn secondary" data-add-meal="snack">Добавить</button>
      </div>
    </div>
    <div class="grid2" id="snacksGrid">
      <div>
        <div class="muted">Нажми “Съесть”, чтобы добавить в “Сегодня”.</div>
        <div id="snackList"></div>
      </div>
      <div class="todayBox" id="snacksTodayCol">
        <div style="font-weight:900">Сегодня</div>
        <div id="todaySnacksList" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <div id="activities" class="tab">
    <div class="tabHeader">
      <div class="tabTitle">Занятия</div>
      <div class="todayToggleRow">
        <button class="btn secondary" data-toggle-today="activities">Сегодня</button>
        <button class="btn secondary" id="btnAddActivity">Добавить</button>
      </div>
    </div>

    <div class="grid2" id="activitiesGrid">
      <div>
        <div class="muted" style="margin:6px 0">Введи ккал за сессию (или минуты) и нажми Enter / Добавить.</div>
        <div id="activityList"></div>
      </div>
      <div class="todayBox" id="activitiesTodayCol">
        <div style="font-weight:900">Сегодня</div>
        <div id="todayActivitiesList" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <div id="barcode" class="tab">
    <div class="tabHeader">
      <div class="tabTitle">Штрихкод</div>
      <div class="todayToggleRow">
        <button class="btn secondary" id="btnBarcodePaste">Вставить</button>
        <button class="btn secondary" id="btnScanStart">Сканировать</button>
        <button class="btn secondary hidden" id="btnScanStop">Стоп</button>
        <button class="btn" id="btnBarcodeSearch">Найти</button>
      </div>
    </div>

    <div class="card">
      <div class="muted">Штрихкод</div>
      <input id="barcodeInput" inputmode="numeric" placeholder="Напр. 3017624010701"/>
      <div class="muted" style="margin-top:8px">Поиск идёт в Open Food Facts.</div>
    </div>

    <div class="card hidden" id="scanCard">
      <div style="font-weight:900">Сканирование</div>
      <div class="muted" style="margin-top:6px">Нужно HTTPS и действие пользователя (кнопка “Сканировать”).</div>
      <div class="scanOverlay" style="margin-top:10px">
        <video id="scanVideo" class="scanVideo" autoplay playsinline muted></video>
        <div class="scanHint" id="scanHint">Ожидание…</div>
      </div>
      <div class="muted" style="margin-top:8px">Используется ZXing (JS-декодер), работает там, где BarcodeDetector недоступен.</div>
    </div>

    <div id="barcodeResult"></div>
  </div>

  <div id="log" class="tab">
    <div class="grid2">
      <div class="card">
        <div style="font-weight:900">Заметки</div>
        <textarea id="notes" placeholder=""></textarea>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
          <button class="btn" id="btnSaveDay">Сохранить день + backup</button>
          <button class="btn danger" id="btnResetDay">Сбросить</button>
        </div>
        <div class="muted" style="margin-top:8px">При сохранении создаётся backup.json.</div>
      </div>

      <div class="card">
        <div style="font-weight:900">Последние дни</div>
        <div id="logList" class="muted"></div>
      </div>
    </div>
  </div>

  <div id="settings" class="tab">
    <div class="card">
      <div style="font-weight:900">Настройки</div>
      <div class="muted" style="margin-top:6px">BMR</div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="muted">Рост</div>
          <input id="setHeight" type="number" min="80" max="250" step="1" placeholder="152"/>
        </div>
        <div>
          <div class="muted">Возраст</div>
          <input id="setAge" type="number" min="12" max="90" step="1" placeholder="30"/>
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="muted">Пол</div>
        <select id="setSex">
          <option value="female">Ж</option>
          <option value="male">М</option>
        </select>
      </div>

      <div style="margin-top:10px">
        <div class="muted">Множитель BMR</div>
        <input id="bmrMultiplier" type="number" min="1" max="2" step="0.05" placeholder="1.20"/>
      </div>

      <div style="margin-top:10px">
        <div class="muted">Цель (ккал/день)</div>
        <input id="goalKcal" type="number" step="10" placeholder="-400"/>
        <div class="muted" style="margin-top:6px">Напр. -400 = дефицит 400 ккал.</div>
      </div>

      <div style="margin-top:10px">
        <div class="muted">Режим нетто</div>
        <select id="nettoMode">
          <option value="nettonobmr">Съедено − спорт</option>
          <option value="nettowithbmr">Съедено − спорт − BMR</option>
          <option value="consumedlimit">Съедено / лимит</option>
          <option value="remaining">Осталось до лимита</option>
        </select>
      </div>

      <div style="margin-top:10px">
        <div class="muted">Название приложения</div>
        <input id="setAppTitle" placeholder="" maxlength="50"/>
      </div>

      <div class="muted" style="margin-top:10px">BMR считается по Mifflin-St Jeor: 10W + 6.25H − 5A + S.</div>

      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
        <button class="btn secondary" id="btnSaveSettings">Сохранить настройки</button>
        <button class="btn secondary" id="btnPersist">Persist storage</button>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <label style="display:flex; gap:10px; align-items:center">
        <input type="checkbox" id="autoSaveOnNewDay" style="width:auto; transform:scale(1.2)"/>
        <span>Автосохранять день при смене даты</span>
      </label>
      <div class="muted" style="margin-top:8px">Если включено — приложение сохранит вчерашний день автоматически.</div>
    </div>

    <div class="card" style="margin-top:10px">
      <label style="display:flex; gap:10px; align-items:center">
        <input type="checkbox" id="favoritesEnabled" style="width:auto; transform:scale(1.2)"/>
        <span>Избранное</span>
      </label>
      <div class="muted" style="margin-top:8px">Можно отмечать блюда/занятия звёздочкой.</div>
    </div>

    <div class="card" style="margin-top:10px">
      <div style="font-weight:900">Debug</div>
      <label style="display:flex; gap:10px; align-items:center; margin-top:10px">
        <input type="checkbox" id="dbgEnabled" style="width:auto; transform:scale(1.2)"/>
        <span>Debug date +1</span>
      </label>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
        <button class="btn secondary" id="dbgReset">Reset date</button>
      </div>
    </div>

    <div class="card" style="margin-top:10px; border:2px solid #dc2626; background:#fef2f2">
      <div style="font-weight:900; color:#dc2626">Опасная зона</div>
      <div class="muted" style="margin-top:6px">Сбросит весь журнал (логи) — блюда/активности останутся.</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
        <button class="btn danger" id="btnResetJournal" style="padding:12px 20px; font-weight:900">Сбросить журнал</button>
      </div>
    </div>
  </div>

  <div id="data" class="tab">
    <div class="grid2">
      <div class="card">
        <div style="font-weight:900">Импорт backup.json</div>
        <input type="file" id="importFile" accept="application/json"/>
        <div class="muted" style="margin-top:8px">meals/activities/logs/shopping/meta.</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
          <button class="btn secondary" id="btnImport">Импорт</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:900">Экспорт</div>
        <div class="muted">Скачает backup.json.</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
          <button class="btn secondary" id="btnExport">Экспорт backup</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900">Список покупок</div>
      <textarea id="shopping" placeholder="12 яиц&#10;300 г курицы&#10;..."></textarea>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
        <button class="btn secondary" id="btnSaveShopping">Сохранить</button>
      </div>
    </div>
  </div>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <h3 id="modalTitle"></h3>
      <div id="modalBody"></div>
      <div class="actions">
        <button class="btn danger" id="modalDelete" style="display:none;margin-right:auto">Удалить</button>
        <button class="btn secondary" id="modalCancel">Отмена</button>
        <button class="btn" id="modalOk">OK</button>
      </div>
    </div>
  </div>

<script type="module">
import * as ZXingBrowser from 'https://unpkg.com/@zxing/browser@0.1.5?module';

/* ---------- IndexedDB ---------- */
const DBNAME = "food-plan-db";
const DBVER = 6;

let statusTimer = null;

window.favoritesEnabled = false;
window.bmrMultiplier = 1.2;
window.goalKcal = -400;
window.nettoMode = "nettonobmr";

function openDb(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DBNAME, DBVER);
    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains("meals")) db.createObjectStore("meals", {keyPath:"id"});
      if(!db.objectStoreNames.contains("activities")) db.createObjectStore("activities", {keyPath:"id"});
      if(!db.objectStoreNames.contains("logs")) db.createObjectStore("logs", {keyPath:"date"});
      if(!db.objectStoreNames.contains("shopping")) db.createObjectStore("shopping", {keyPath:"id"});
      if(!db.objectStoreNames.contains("meta")) db.createObjectStore("meta", {keyPath:"key"});
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function txGetAll(store){
  const db = await openDb();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, "readonly");
    const req = tx.objectStore(store).getAll();
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function txPut(store, value){
  const db = await openDb();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, "readwrite");
    tx.objectStore(store).put(value);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}
async function txDelete(store, key){
  const db = await openDb();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, "readwrite");
    tx.objectStore(store).delete(key);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}
async function txClear(store){
  const db = await openDb();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, "readwrite");
    const req = tx.objectStore(store).clear();
    req.onsuccess = () => resolve(true);
    req.onerror = () => reject(req.error);
  });
}
async function txBulkPut(store, arr){
  const db = await openDb();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, "readwrite");
    const os = tx.objectStore(store);
    for(const item of arr) os.put(item);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}
async function metaGet(key){
  const db = await openDb();
  return new Promise((resolve) => {
    const tx = db.transaction("meta", "readonly");
    const req = tx.objectStore("meta").get(key);
    req.onsuccess = () => resolve(req.result?.value ?? null);
    req.onerror = () => resolve(null);
  });
}
async function metaSet(key, value){
  await txPut("meta", {key, value});
}

/* ---------- State ---------- */
let meals;
let activities;
let todayMealEntries = []; // [{entryId, mealId}]
let todayActivityEntries = []; // [{id, minutes}]

function setStatus(msg){
  const el = document.getElementById("status");
  el.textContent = msg;
  if(statusTimer) clearTimeout(statusTimer);
  if(msg) statusTimer = setTimeout(() => el.textContent = "", 4000);
}
function pad2(n){ return String(n).padStart(2,"0"); }
function isoFromDate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function escapeHtml(s){
  return String(s ?? "")
    .replace(/[&<>"']/g, m => ({'&':"&amp;",'<':"&lt;",'>':"&gt;",'"':"&quot;","'":"&#039;"}[m]));
}
function uid(prefix){
  if(crypto && crypto.randomUUID) return `${prefix}-${crypto.randomUUID()}`;
  return `${prefix}-${Date.now()}-${Math.random().toString(16).slice(2)}`;
}

/* ---------- Date debug ---------- */
async function getAppDateISO(){
  const dbg = await metaGet("debug.enabled");
  if(dbg){
    let cur = await metaGet("debug.dateISO");
    if(!cur) cur = isoFromDate(new Date());
    await metaSet("debug.dateISO", cur);
    return cur;
  }
  return isoFromDate(new Date());
}
async function advanceAppDateIfDebug(){
  const dbg = await metaGet("debug.enabled");
  if(!dbg) return;
  const curISO = await metaGet("debug.dateISO") || isoFromDate(new Date());
  const [y,m,d] = curISO.split("-").map(x => parseInt(x,10));
  const dt = new Date(y, m-1, d);
  dt.setDate(dt.getDate()+1);
  await metaSet("debug.dateISO", isoFromDate(dt));
}
async function refreshDateUI(){
  const date = await getAppDateISO();
  const dbg = await metaGet("debug.enabled");
  document.getElementById("uiDate").textContent = date;
  document.getElementById("uiDebugTag").textContent = dbg ? "debug" : "";
}

/* ---------- Calories ---------- */
function getMealById(id){ return meals.find(m => m.id === id); }
function calcEatKcal(){
  let sum = 0;
  for(const e of (todayMealEntries || [])){
    const m = getMealById(e.mealId);
    if(m) sum += Number(m.calories || 0);
  }
  return Math.round(sum);
}
function calcBurnKcalExercise(){
  let sum = 0;
  for(const e of (todayActivityEntries || [])){
    const a = activities.find(x => x.id === e.id);
    if(!a) continue;
    sum += (Number(a.kcalPerHour || 0) * Number(e.minutes || 0) / 60);
  }
  return Math.round(sum);
}
function calcBasalKcalPerDayFrom(weight){
  const h = Number(document.getElementById("setHeight")?.value || 0);
  const age = Number(document.getElementById("setAge")?.value || 0);
  const sex = String(document.getElementById("setSex")?.value || "female");
  const w = Number(weight || 0) || 55;
  if(!h || !age || !w) return 0;
  const s = (sex === "male") ? 5 : -161;
  const base = 10*w + 6.25*h - 5*age + s;
  const mult = Number(window.bmrMultiplier || 1);
  return Math.round(base * mult);
}
function calcBasalKcalPerDay(){
  const w = Number(document.getElementById("weight")?.value || 55);
  return calcBasalKcalPerDayFrom(w);
}
function calcDayLimitKcal(){
  const basal = calcBasalKcalPerDay();
  const burnExercise = calcBurnKcalExercise();
  const goal = Number(window.goalKcal || 0);
  return Math.round(basal + burnExercise + goal);
}
function updateLimitBar(eat, limit){
  const bar = document.getElementById("limitBar");
  if(!limit || !Number.isFinite(limit) || limit <= 0){ bar.style.width = "0%"; return; }
  const pct = eat / limit * 100;
  const pctClamped = Math.max(0, Math.min(100, pct));
  bar.style.width = pctClamped.toFixed(0) + "%";
}
function applyNettoMode(eat, burnExercise, basal, limit){
  const mode = String(window.nettoMode || "nettonobmr");
  const nettoTitle = document.getElementById("nettoTitle");
  if(mode === "consumedlimit"){
    nettoTitle.textContent = "Съедено / лимит";
    document.getElementById("todayNet").textContent = `${eat} / ${limit}`;
    document.getElementById("nettoLabel").textContent = "";
    return;
  }
  if(mode === "remaining"){
    nettoTitle.textContent = "Осталось";
    document.getElementById("todayNet").textContent = Math.round((limit || 0) - eat);
    document.getElementById("nettoLabel").textContent = "ккал";
    return;
  }
  if(mode === "nettowithbmr"){
    nettoTitle.textContent = "Нетто (с BMR)";
    document.getElementById("todayNet").textContent = eat - burnExercise - basal;
    document.getElementById("nettoLabel").textContent = "ккал";
    return;
  }
  nettoTitle.textContent = "Нетто";
  document.getElementById("todayNet").textContent = eat - burnExercise;
  document.getElementById("nettoLabel").textContent = "ккал";
}
function updateTopTotals(){
  const eat = calcEatKcal();
  const burnExercise = calcBurnKcalExercise();
  const basal = calcBasalKcalPerDay();
  const limit = calcDayLimitKcal();
  document.getElementById("todayEat").textContent = eat;
  document.getElementById("todayBurn").textContent = burnExercise;
  document.getElementById("bmrInfo").textContent = basal ? `BMR: ${basal} (x${Number(window.bmrMultiplier||1).toFixed(2)})` : "";
  applyNettoMode(eat, burnExercise, basal, limit);
  updateLimitBar(eat, limit);
}
function cycleNettoMode(){
  const order = ["nettonobmr","nettowithbmr","consumedlimit","remaining"];
  const cur = String(window.nettoMode || order[0]);
  const idx = Math.max(0, order.indexOf(cur));
  const next = order[(idx+1) % order.length];
  window.nettoMode = next;
  const sel = document.getElementById("nettoMode");
  if(sel) sel.value = next;
  metaSet("settings.nettoMode", next);
  updateTopTotals();
}

/* ---------- Draft ---------- */
async function saveDraft(){
  const date = await getAppDateISO();
  const draft = {
    date,
    todayMealEntries: todayMealEntries || [],
    todayActivityEntries: todayActivityEntries || [],
    weight: document.getElementById("weight").value,
    steps: document.getElementById("steps").value,
    notes: document.getElementById("notes").value
  };
  await metaSet("draft", draft);
}
async function migrateOldDraftToMealEntries(draft){
  const out = [];
  const seen = new Set();
  if(Array.isArray(draft?.selectedMealIds)){
    for(const id of draft.selectedMealIds){
      if(!id || seen.has(id)) continue;
      out.push({entryId: uid("e"), mealId: id});
      seen.add(id);
    }
  }
  if(draft?.snackCounts && typeof draft.snackCounts === "object"){
    for(const [id, cnt] of Object.entries(draft.snackCounts)){
      const n = Math.max(0, Math.round(Number(cnt || 0)));
      for(let i=0;i<n;i++) out.push({entryId: uid("e"), mealId: id});
    }
  }
  return out;
}
async function loadDraft(){
  const draft = await metaGet("draft");
  const date = await getAppDateISO();
  const savedWeight = await metaGet("profile.weight");

  if(draft && draft.date === date){
    if(Array.isArray(draft.todayMealEntries)) todayMealEntries = draft.todayMealEntries;
    else todayMealEntries = await migrateOldDraftToMealEntries(draft);

    todayActivityEntries = Array.isArray(draft.todayActivityEntries) ? draft.todayActivityEntries : [];

    document.getElementById("weight").value = (draft.weight ?? "");
    document.getElementById("steps").value = (draft.steps ?? "");
    document.getElementById("notes").value = (draft.notes ?? "");

    if(!String(document.getElementById("weight").value || "").trim() && savedWeight != null){
      document.getElementById("weight").value = String(savedWeight);
    }
  } else {
    todayMealEntries = [];
    todayActivityEntries = [];
    document.getElementById("steps").value = "";
    document.getElementById("notes").value = "";
    document.getElementById("weight").value = (savedWeight != null) ? String(savedWeight) : "";
  }
}
async function autoSaveDraftIfDateChanged(){
  const draft = await metaGet("draft");
  const todayISO = await getAppDateISO();
  if(!draft || !draft.date || draft.date === todayISO) return;

  const autoSaveSetting = await metaGet("settings.autoSaveOnNewDay");
  const autoSaveEnabled = (autoSaveSetting === null) ? true : !!autoSaveSetting;

  const hasAny =
    (Array.isArray(draft.todayMealEntries) && draft.todayMealEntries.length) ||
    (Array.isArray(draft.todayActivityEntries) && draft.todayActivityEntries.length) ||
    (draft.steps && String(draft.steps).trim()) ||
    (draft.notes && String(draft.notes).trim()) ||
    (Array.isArray(draft.selectedMealIds) && draft.selectedMealIds.length) ||
    (draft.snackCounts && Object.keys(draft.snackCounts).length);

  if(autoSaveEnabled && hasAny){
    const mealEntries = Array.isArray(draft.todayMealEntries)
      ? draft.todayMealEntries
      : await migrateOldDraftToMealEntries(draft);

    let eat = 0;
    for(const e of (mealEntries || [])){
      const m = meals.find(x => x.id === e.mealId);
      if(m) eat += Number(m.calories || 0);
    }
    eat = Math.round(eat);

    let burnExercise = 0;
    for(const e of (draft.todayActivityEntries || [])){
      const a = activities.find(x => x.id === e.id);
      if(!a) continue;
      burnExercise += (Number(a.kcalPerHour || 0) * Number(e.minutes || 0) / 60);
    }
    burnExercise = Math.round(burnExercise);

    const weight = Number(draft.weight || 0) || 55;
    const basal = calcBasalKcalPerDayFrom(weight);
    const burnTotal = burnExercise + basal;
    const goal = Number(window.goalKcal || 0);
    const limit = Math.round(basal + burnExercise + goal);
    const remaining = Math.round(limit - eat);

    await txPut("logs", {
      date: draft.date,
      weight: String(draft.weight ?? ""),
      steps: String(draft.steps ?? ""),
      mealEntries: mealEntries || [],
      activityEntries: Array.from(draft.todayActivityEntries || []),
      eatCalories: eat,
      burnExerciseCalories: burnExercise,
      basalCalories: basal,
      burnCalories: burnTotal,
      netCalories: eat - burnTotal,
      goalKcal: goal,
      limitCalories: limit,
      remainingCalories: remaining,
      notes: String(draft.notes ?? ""),
      autoSaved: true,
      updatedAt: new Date().toISOString()
    });
  }

  await metaSet("draft", {
    date: todayISO,
    todayMealEntries: [],
    todayActivityEntries: [],
    weight: document.getElementById("weight").value,
    steps: "",
    notes: ""
  });
}

/* ---------- Render food ---------- */
function sortMaybeFav(list){
  if(!window.favoritesEnabled) return list;
  return list.slice().sort((a,b) =>
    Number(!!b.favorite) - Number(!!a.favorite) ||
    String(a.name).localeCompare(String(b.name), "ru")
  );
}
function mealCardHtml(m){
  const star = window.favoritesEnabled
    ? `<button class="btn secondary tiny" data-fav-meal="${escapeHtml(m.id)}" title="Избранное" style="padding:4px 8px">${m.favorite ? "★" : "☆"}</button>`
    : "";
  return `
    <div class="card" data-meal-card="${escapeHtml(m.id)}">
      <div class="mealCardHead">
        <div>
          <div style="font-weight:900">${escapeHtml(m.name)}</div>
          ${m.short ? `<div class="muted mealMeta">${escapeHtml(m.short)}</div>` : ``}
          ${m.ingredients ? `<div class="muted mealMeta">${escapeHtml(m.ingredients)}</div>` : ``}
        </div>
        <div style="text-align:right">
          <div class="kcal">${escapeHtml(m.calories)}</div>
        </div>
      </div>
      <div class="mealCardActions">
        ${star}
        <button class="btn tiny" data-meal-eat="${escapeHtml(m.id)}">Съесть</button>
      </div>
    </div>
  `;
}
function renderMealCategory(cat, listId){
  const root = document.getElementById(listId);
  const list = sortMaybeFav(meals.filter(m => m.category === cat));
  if(!list.length){
    root.innerHTML = `<div class="card"><div style="font-weight:900">Пусто</div><div class="muted">Добавь блюдо.</div></div>`;
    return;
  }
  root.innerHTML = list.map(mealCardHtml).join("");
}
function renderTodayByCategory(cat, todayListId){
  const root = document.getElementById(todayListId);
  const entries = (todayMealEntries || []).filter(e => {
    const m = getMealById(e.mealId);
    return m && m.category === cat;
  });

  if(!entries.length){
    root.innerHTML = `<div class="muted">Пока нет.</div>`;
    return;
  }

  root.innerHTML = entries.map(e => {
    const m = getMealById(e.mealId);
    return `
      <div class="itemRow">
        <div>
          <div style="font-weight:900">${escapeHtml(m?.name ?? "??")}</div>
          <div class="muted">${escapeHtml(m?.calories ?? 0)} ккал</div>
        </div>
        <div>
          <button class="btn danger tiny" data-del-meal-entry="${escapeHtml(e.entryId)}">Удалить</button>
        </div>
      </div>
    `;
  }).join("");
}
function renderFoodAll(){
  renderMealCategory("breakfast","breakfastList");
  renderMealCategory("lunch","lunchList");
  renderMealCategory("dinner","dinnerList");
  renderMealCategory("treat","treatList");
  renderMealCategory("snack","snackList");

  renderTodayByCategory("breakfast","todayBreakfastList");
  renderTodayByCategory("lunch","todayLunchList");
  renderTodayByCategory("dinner","todayDinnerList");
  renderTodayByCategory("treat","todayTreatList");
  renderTodayByCategory("snack","todaySnacksList");
}

/* ---------- Activities ---------- */
function renderActivities(){
  const listEl = document.getElementById("activityList");
  const list = sortMaybeFav(activities.slice());
  if(!list.length){
    listEl.innerHTML = `<div class="card"><div style="font-weight:900">Пусто</div><div class="muted">Добавь активность.</div></div>`;
  } else {
    listEl.innerHTML = list.map(a => {
      const star = window.favoritesEnabled
        ? `<button class="btn secondary tiny" data-fav-act="${escapeHtml(a.id)}" title="Избранное" style="padding:4px 8px">${a.favorite ? "★" : "☆"}</button>`
        : "";
      return `
        <div class="card" data-act-card="${escapeHtml(a.id)}">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start">
            <div>
              <div style="font-weight:900">${escapeHtml(a.name)}</div>
              <div class="muted">${escapeHtml(a.kcalPerHour)} ккал/ч</div>
            </div>
            <div style="min-width: 240px">
              <div style="display:flex; gap:8px; justify-content:flex-end; align-items:center">
                ${star}
              </div>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px;">
                <input type="number" min="0" step="5" inputmode="numeric" placeholder="ккал" enterkeyhint="done" data-act-kcal="${escapeHtml(a.id)}">
                <input type="number" min="0" step="5" inputmode="numeric" placeholder="мин" enterkeyhint="done" data-act-min="${escapeHtml(a.id)}">
              </div>
              <button class="btn" style="width:100%; margin-top:8px" data-act-add="${escapeHtml(a.id)}">Добавить</button>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  const todayEl = document.getElementById("todayActivitiesList");
  if(!todayActivityEntries.length){
    todayEl.innerHTML = `<div class="muted">Пока нет.</div>`;
  } else {
    todayEl.innerHTML = todayActivityEntries.map((e, idx) => {
      const a = activities.find(x => x.id === e.id);
      const burn = a ? Math.round(Number(a.kcalPerHour || 0) * Number(e.minutes || 0) / 60) : 0;
      return `
        <div class="itemRow">
          <div>
            <div style="font-weight:900">${escapeHtml(a?.name ?? "??")}</div>
            <div class="muted">${escapeHtml(e.minutes)} мин • ${burn} ккал</div>
          </div>
          <div>
            <button class="btn danger tiny" data-del-act-idx="${idx}">Удалить</button>
          </div>
        </div>
      `;
    }).join("");
  }
}

/* ---------- Modal ---------- */
let modalOnOk = null;
let modalOnDelete = null;

function openModal(title, bodyHtml, okText="OK", showDelete=false, onOk=null, onDelete=null){
  document.getElementById("modalTitle").textContent = title;
  document.getElementById("modalBody").innerHTML = bodyHtml;
  document.getElementById("modalOk").textContent = okText;

  modalOnOk = onOk;
  modalOnDelete = onDelete;

  const delBtn = document.getElementById("modalDelete");
  delBtn.style.display = showDelete ? "inline-block" : "none";

  document.getElementById("modalBack").style.display = "flex";
}
function closeModal(){
  document.getElementById("modalBack").style.display = "none";
  document.getElementById("modalBody").innerHTML = "";
  modalOnOk = null;
  modalOnDelete = null;
}
function wireModalButtons(){
  document.getElementById("modalCancel").addEventListener("click", closeModal);
  document.getElementById("modalBack").addEventListener("click", (e) => {
    if(e.target.id === "modalBack") closeModal();
  });
  document.getElementById("modalOk").addEventListener("click", async () => {
    if(!modalOnOk){ closeModal(); return; }
    const res = await modalOnOk();
    if(res !== false) closeModal();
  });
  document.getElementById("modalDelete").addEventListener("click", async () => {
    if(!modalOnDelete) return;
    if(!confirm("Удалить?")) return;
    await modalOnDelete();
    closeModal();
  });
}

function mealModalBody(meal){
  const cat = meal?.category ?? "breakfast";
  return `
    <div class="row2">
      <div>
        <div class="muted">Категория</div>
        <select id="mCat">
          <option value="breakfast" ${cat==="breakfast"?"selected":""}>Завтрак</option>
          <option value="lunch" ${cat==="lunch"?"selected":""}>Обед</option>
          <option value="dinner" ${cat==="dinner"?"selected":""}>Ужин</option>
          <option value="treat" ${cat==="treat"?"selected":""}>Вкусняшки</option>
          <option value="snack" ${cat==="snack"?"selected":""}>Перекус</option>
        </select>
      </div>
      <div>
        <div class="muted">Ккал (порция)</div>
        <input id="mKcal" type="number" min="1" step="1" placeholder="100" value="${escapeHtml(meal?.calories ?? "")}">
      </div>
    </div>

    <div style="margin-top:10px">
      <div class="muted">Название</div>
      <input id="mName" placeholder="" value="${escapeHtml(meal?.name ?? "")}">
    </div>

    <div style="margin-top:10px">
      <div class="muted">Коротко</div>
      <input id="mShort" placeholder="" value="${escapeHtml(meal?.short ?? "")}">
    </div>

    <div style="margin-top:10px">
      <div class="muted">Ингредиенты</div>
      <textarea id="mIng" placeholder="">${escapeHtml(meal?.ingredients ?? "")}</textarea>
    </div>

    <div style="margin-top:10px">
      <div class="muted">Приготовление</div>
      <textarea id="mPrep" placeholder="">${escapeHtml(meal?.prep ?? "")}</textarea>
    </div>
  `;
}
async function openAddMealModal(defaultCategory){
  openModal("Добавить блюдо", mealModalBody({category: defaultCategory}), "Сохранить", false, async () => {
    const name = document.getElementById("mName").value.trim();
    const calories = Number(document.getElementById("mKcal").value);
    if(!name){ setStatus("Название обязательно."); return false; }
    if(!Number.isFinite(calories) || calories <= 0){ setStatus("Ккал должны быть > 0."); return false; }

    const meal = {
      id: uid("m"),
      category: document.getElementById("mCat").value,
      name,
      calories: Math.round(calories),
      short: document.getElementById("mShort").value.trim(),
      ingredients: document.getElementById("mIng").value.trim(),
      prep: document.getElementById("mPrep").value.trim(),
      favorite: false,
      updatedAt: new Date().toISOString()
    };

    await txPut("meals", meal);
    meals = await txGetAll("meals");
    renderFoodAll();
    updateTopTotals();
    setStatus("Сохранено.");
  });
}
async function openEditMealModal(mealId){
  const meal = meals.find(x => x.id === mealId);
  if(!meal) return;

  openModal("Редактировать блюдо", mealModalBody(meal), "Сохранить", true,
    async () => {
      const name = document.getElementById("mName").value.trim();
      const calories = Number(document.getElementById("mKcal").value);
      if(!name){ setStatus("Название обязательно."); return false; }
      if(!Number.isFinite(calories) || calories <= 0){ setStatus("Ккал должны быть > 0."); return false; }

      const updated = {
        ...meal,
        category: document.getElementById("mCat").value,
        name,
        calories: Math.round(calories),
        short: document.getElementById("mShort").value.trim(),
        ingredients: document.getElementById("mIng").value.trim(),
        prep: document.getElementById("mPrep").value.trim(),
        updatedAt: new Date().toISOString()
      };

      await txPut("meals", updated);
      meals = await txGetAll("meals");
      renderFoodAll();
      updateTopTotals();
      setStatus("Сохранено.");
    },
    async () => {
      await txDelete("meals", meal.id);
      todayMealEntries = (todayMealEntries || []).filter(e => e.mealId !== meal.id);
      await saveDraft();
      meals = await txGetAll("meals");
      renderFoodAll();
      updateTopTotals();
      setStatus("Удалено.");
    }
  );
}

function activityModalBody(act){
  return `
    <div class="row2">
      <div>
        <div class="muted">Название</div>
        <input id="aName" placeholder="" value="${escapeHtml(act?.name ?? "")}">
      </div>
      <div>
        <div class="muted">Ккал/час</div>
        <input id="aKph" type="number" min="1" step="10" placeholder="300" value="${escapeHtml(act?.kcalPerHour ?? "")}">
      </div>
    </div>
  `;
}
async function openAddActivityModal(){
  openModal("Добавить активность", activityModalBody(null), "Сохранить", false, async () => {
    const name = document.getElementById("aName").value.trim();
    const kph = Number(document.getElementById("aKph").value);
    if(!name){ setStatus("Название обязательно."); return false; }
    if(!Number.isFinite(kph) || kph <= 0){ setStatus("Ккал/час должны быть > 0."); return false; }

    await txPut("activities", {
      id: uid("a"),
      name,
      kcalPerHour: Math.round(kph),
      favorite: false,
      updatedAt: new Date().toISOString()
    });

    activities = await txGetAll("activities");
    renderActivities();
    setStatus("Сохранено.");
  });
}
async function openEditActivityModal(actId){
  const act = activities.find(x => x.id === actId);
  if(!act) return;

  openModal("Редактировать активность", activityModalBody(act), "Сохранить", true,
    async () => {
      const name = document.getElementById("aName").value.trim();
      const kph = Number(document.getElementById("aKph").value);
      if(!name){ setStatus("Название обязательно."); return false; }
      if(!Number.isFinite(kph) || kph <= 0){ setStatus("Ккал/час должны быть > 0."); return false; }

      await txPut("activities", {
        ...act,
        name,
        kcalPerHour: Math.round(kph),
        updatedAt: new Date().toISOString()
      });

      activities = await txGetAll("activities");
      renderActivities();
      updateTopTotals();
      setStatus("Сохранено.");
    },
    async () => {
      await txDelete("activities", act.id);
      todayActivityEntries = (todayActivityEntries || []).filter(e => e.id !== act.id);
      await saveDraft();
      activities = await txGetAll("activities");
      renderActivities();
      updateTopTotals();
      setStatus("Удалено.");
    }
  );
}

/* ---------- Long press ---------- */
function installLongPress(root, selector, getId, openEditor){
  let t = null;
  root.addEventListener("pointerdown", (ev) => {
    const el = ev.target.closest(selector);
    if(!el) return;
    t = setTimeout(() => {
      const id = getId(el);
      openEditor(id);
    }, 650);
  });
  const cancel = () => { if(t){ clearTimeout(t); t = null; } };
  root.addEventListener("pointerup", cancel);
  root.addEventListener("pointercancel", cancel);
  root.addEventListener("pointerleave", cancel);

  root.addEventListener("contextmenu", (ev) => {
    ev.preventDefault();
    const el = ev.target.closest(selector);
    if(!el) return;
    const id = getId(el);
    openEditor(id);
  });
}

/* ---------- Logs ---------- */
async function renderLogs(){
  const logs = await txGetAll("logs");
  logs.sort((a,b) => b.date.localeCompare(a.date));
  const el = document.getElementById("logList");
  if(!logs.length){ el.textContent = "Пока пусто."; return; }
  el.innerHTML = logs.slice(0,12).map(l => {
    const limit = (l.limitCalories ?? "");
    const rem = (l.remainingCalories ?? "");
    const goal = (l.goalKcal ?? "");
    return `
      <div style="margin:8px 0">
        <div><b>${escapeHtml(l.date)}</b> • ${escapeHtml(l.eatCalories ?? 0)} / ${escapeHtml(l.burnCalories ?? 0)} • нетто ${escapeHtml(l.netCalories ?? 0)}</div>
        <div class="muted">лимит: ${escapeHtml(limit)} • осталось: ${escapeHtml(rem)} • цель: ${escapeHtml(goal)} • вес: ${escapeHtml(l.weight ?? "-")} • шаги: ${escapeHtml(l.steps ?? "-")} ${l.autoSaved ? "• autoSaved" : ""}</div>
      </div>
    `;
  }).join("");
}

/* ---------- Settings ---------- */
async function loadSettings(){
  const h = await metaGet("settings.height");
  const a = await metaGet("settings.age");
  const sex = await metaGet("settings.sex");
  const bmrMult = await metaGet("settings.bmrMultiplier");
  const goalKcal = await metaGet("settings.goalKcal");

  let mode = await metaGet("settings.nettoMode");
  if(!mode){
    const oldMode = await metaGet("settings.nettoTileMode");
    const oldWithBmr = await metaGet("settings.nettoWithBmr");
    if(oldMode === "consumedLimit") mode = "consumedlimit";
    else if(oldMode === "remaining") mode = "remaining";
    else mode = oldWithBmr ? "nettowithbmr" : "nettonobmr";
    await metaSet("settings.nettoMode", mode);
  }

  const autoSave = await metaGet("settings.autoSaveOnNewDay");
  const favEnabled = await metaGet("settings.favoritesEnabled");
  const appTitle = await metaGet("settings.appTitle");

  document.getElementById("setHeight").value = h ?? 152;
  document.getElementById("setAge").value = a ?? 30;
  document.getElementById("setSex").value = sex ?? "female";

  const mult = (bmrMult === null || bmrMult === undefined || bmrMult === "") ? 1.2 : Number(bmrMult);
  document.getElementById("bmrMultiplier").value = Number.isFinite(mult) ? mult : 1.2;

  const goal = (goalKcal === null || goalKcal === undefined || goalKcal === "") ? -400 : Number(goalKcal);
  document.getElementById("goalKcal").value = Number.isFinite(goal) ? goal : -400;

  const okModes = ["nettonobmr","nettowithbmr","consumedlimit","remaining"];
  mode = okModes.includes(String(mode)) ? String(mode) : "nettonobmr";
  document.getElementById("nettoMode").value = mode;

  document.getElementById("autoSaveOnNewDay").checked = (autoSave === null) ? true : !!autoSave;
  document.getElementById("favoritesEnabled").checked = !!favEnabled;

  document.getElementById("setAppTitle").value = appTitle ?? "";
  document.getElementById("appTitle").textContent = appTitle ?? "Food Plan";

  window.favoritesEnabled = !!favEnabled;
  window.bmrMultiplier = Number.isFinite(mult) ? mult : 1.2;
  window.goalKcal = Number.isFinite(goal) ? goal : -400;
  window.nettoMode = mode;

  const dbg = await metaGet("debug.enabled");
  document.getElementById("dbgEnabled").checked = !!dbg;

  const todayColsHidden = await metaGet("ui.todayHidden") || {};
  applyTodayHiddenState(todayColsHidden);
}
async function saveSettings(){
  const h = Number(document.getElementById("setHeight").value || 0);
  const a = Number(document.getElementById("setAge").value || 0);
  const sex = String(document.getElementById("setSex").value || "female");
  const bmrMult = Number(document.getElementById("bmrMultiplier").value || 1.2);
  const goal = Number(document.getElementById("goalKcal").value || -400);
  const mode = String(document.getElementById("nettoMode").value || "nettonobmr");
  const autoSave = document.getElementById("autoSaveOnNewDay").checked;
  const favEnabled = document.getElementById("favoritesEnabled").checked;
  const appTitle = document.getElementById("setAppTitle").value.trim();

  if(!h || !a){ setStatus("Рост и возраст обязательны."); return; }
  if(!Number.isFinite(bmrMult) || bmrMult < 1 || bmrMult > 2){ setStatus("BMR множитель: 1.00–2.00"); return; }
  if(!Number.isFinite(goal) || goal < -3000 || goal > 3000){ setStatus("Цель: -3000…3000"); return; }
  const okModes = ["nettonobmr","nettowithbmr","consumedlimit","remaining"];
  if(!okModes.includes(mode)){ setStatus("Неизвестный режим."); return; }

  await metaSet("settings.height", h);
  await metaSet("settings.age", a);
  await metaSet("settings.sex", sex);
  await metaSet("settings.bmrMultiplier", bmrMult);
  await metaSet("settings.goalKcal", goal);
  await metaSet("settings.nettoMode", mode);
  await metaSet("settings.autoSaveOnNewDay", autoSave);
  await metaSet("settings.favoritesEnabled", favEnabled);
  await metaSet("settings.appTitle", appTitle);

  document.getElementById("appTitle").textContent = appTitle || "Food Plan";

  window.favoritesEnabled = favEnabled;
  window.bmrMultiplier = bmrMult;
  window.goalKcal = goal;
  window.nettoMode = mode;

  renderFoodAll();
  renderActivities();
  updateTopTotals();
  setStatus("Настройки сохранены.");
}

/* ---------- Shopping ---------- */
async function loadShopping(){
  const rows = await txGetAll("shopping");
  document.getElementById("shopping").value = (rows.find(x => x.id === "main")?.text ?? "");
}
async function saveShopping(){
  await txPut("shopping", {id:"main", text: document.getElementById("shopping").value, updatedAt: new Date().toISOString()});
  setStatus("Сохранено.");
}

/* ---------- Backup ---------- */
async function buildBackupObject(){
  return {
    schema: 14,
    exportedAt: new Date().toISOString(),
    meals: await txGetAll("meals"),
    activities: await txGetAll("activities"),
    logs: await txGetAll("logs"),
    shopping: await txGetAll("shopping"),
    meta: await txGetAll("meta")
  };
}
function downloadJson(filename, obj){
  const text = JSON.stringify(obj, null, 2);
  const blob = new Blob([text], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
async function exportBackupNow(){
  const date = await getAppDateISO();
  downloadJson(`backup-${date}.json`, await buildBackupObject());
  setStatus("Экспорт готов.");
}
async function importBackup(file){
  const obj = JSON.parse(await file.text());
  if(!obj || ![1,2,3,4,5,6,7,8,9,10,11,12,13,14].includes(obj.schema)) throw new Error("Bad schema");
  await txClear("meals");
  await txClear("activities");
  await txClear("logs");
  await txClear("shopping");
  await txClear("meta");
  await txBulkPut("meals", obj.meals || []);
  await txBulkPut("activities", obj.activities || []);
  await txBulkPut("logs", obj.logs || []);
  await txBulkPut("shopping", obj.shopping || []);
  await txBulkPut("meta", obj.meta || []);
}

/* ---------- Persist ---------- */
async function requestPersist(){
  try{
    if(navigator.storage?.persist){
      const ok = await navigator.storage.persist();
      setStatus(ok ? "Persistent storage включён." : "Persistent storage не включён.");
    } else setStatus("persist() не поддерживается.");
  }catch(e){
    setStatus("Ошибка persistent storage.");
  }
}

/* ---------- Seeds ---------- */
function seedMealsIfEmpty(arr){
  if(arr.length) return arr;
  return [
    {id:"b1",category:"breakfast",name:"Овсянка + банан",calories:320,short:"",ingredients:"",favorite:false},
    {id:"l1",category:"lunch",name:"Курица + рис",calories:420,short:"",ingredients:"",favorite:false},
    {id:"s1",category:"snack",name:"Яблоко",calories:55,short:"1 шт",favorite:false},
    {id:"s2",category:"snack",name:"Йогурт",calories:60,short:"1 шт",favorite:false}
  ];
}
function seedActivitiesIfEmpty(arr){
  if(arr.length) return arr;
  return [
    {id:"a1",name:"Степпер",kcalPerHour:500,favorite:false},
    {id:"a2",name:"Ходьба",kcalPerHour:250,favorite:false}
  ];
}

/* ---------- Today blocks hide/show ---------- */
const todayColMap = {
  breakfast: {grid:"breakfastGrid", col:"breakfastTodayCol"},
  lunch: {grid:"lunchGrid", col:"lunchTodayCol"},
  dinner: {grid:"dinnerGrid", col:"dinnerTodayCol"},
  treat: {grid:"treatGrid", col:"treatTodayCol"},
  snacks: {grid:"snacksGrid", col:"snacksTodayCol"},
  activities: {grid:"activitiesGrid", col:"activitiesTodayCol"}
};
function applyTodayHiddenState(state){
  for(const [k, ids] of Object.entries(todayColMap)){
    const hidden = !!state?.[k];
    const col = document.getElementById(ids.col);
    const grid = document.getElementById(ids.grid);
    if(!col || !grid) continue;
    col.classList.toggle("hidden", hidden);
    if(hidden) grid.style.gridTemplateColumns = "1fr";
    else grid.style.gridTemplateColumns = "";
  }
}
async function toggleTodayCol(tabKey){
  const cur = await metaGet("ui.todayHidden") || {};
  cur[tabKey] = !cur[tabKey];
  await metaSet("ui.todayHidden", cur);
  applyTodayHiddenState(cur);
}

/* ---------- Food actions ---------- */
function addMealToToday(mealId){
  todayMealEntries.push({entryId: uid("e"), mealId});
}
function deleteMealEntry(entryId){
  todayMealEntries = (todayMealEntries || []).filter(e => e.entryId !== entryId);
}

/* ---------- Barcode lookup (Open Food Facts) ---------- */
let lastOff = { barcode: null, product: null, kcal100: null, kcalServing: null, displayName: null };

function offGetKcalFromNutriments(n){
  if(!n || typeof n !== "object") return {kcal100: null, kcalServing: null};
  let kcal100 = n["energy-kcal_100g"];
  let kcalServing = n["energy-kcal_serving"];

  if((kcal100 == null || kcal100 === "") && n["energy_100g"] != null){
    const unit = String(n["energy_unit"] || "").toLowerCase();
    const e = Number(n["energy_100g"]);
    if(Number.isFinite(e) && unit === "kj") kcal100 = e / 4.184;
    else if(Number.isFinite(e) && unit === "kcal") kcal100 = e;
  }
  if((kcalServing == null || kcalServing === "") && n["energy_serving"] != null){
    const unit = String(n["energy_unit"] || "").toLowerCase();
    const e = Number(n["energy_serving"]);
    if(Number.isFinite(e) && unit === "kj") kcalServing = e / 4.184;
    else if(Number.isFinite(e) && unit === "kcal") kcalServing = e;
  }

  const norm = (x) => {
    const v = Number(x);
    return Number.isFinite(v) ? Math.round(v) : null;
  };
  return {kcal100: norm(kcal100), kcalServing: norm(kcalServing)};
}
async function fetchOffProductByBarcode(code){
  const cleaned = String(code || "").trim();
  if(!cleaned) return null;
  const url = `https://world.openfoodfacts.org/api/v2/product/${encodeURIComponent(cleaned)}?fields=code,product_name,product_name_en,brands,quantity,serving_size,nutriments,ingredients_text,ingredients_text_en`;
  const r = await fetch(url);
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  const data = await r.json();
  if(data && data.status === 0) return null;
  if(data && data.product) return data.product;
  if(data && data.code) return data;
  return null;
}
function offPickDisplayName(p){
  const name = p.product_name || p.product_name_en || "Без названия";
  const brands = (p.brands || "").trim();
  return brands ? `${name} (${brands})` : name;
}
async function ensureOffMealExists({barcode, product, category}){
  const id = `off-${barcode}`;
  let existing = meals.find(m => m.id === id);
  const nutr = product?.nutriments || {};
  const {kcal100, kcalServing} = offGetKcalFromNutriments(nutr);
  const kcal = (kcalServing != null) ? kcalServing : (kcal100 != null ? kcal100 : 0);

  const short =
    (kcalServing != null) ? `OFF: ${kcalServing} ккал/порц` :
    (kcal100 != null) ? `OFF: ${kcal100} ккал/100г` :
    `OFF: нет ккал`;

  const ingredients = product?.ingredients_text || product?.ingredients_text_en || "";

  const baseMeal = {
    id,
    category,
    name: offPickDisplayName(product),
    calories: Math.max(1, Math.round(Number(kcal || 0) || 0)) || 1,
    short,
    ingredients,
    prep: "",
    favorite: false,
    updatedAt: new Date().toISOString(),
    source: "openfoodfacts",
    barcode: String(barcode)
  };

  if(existing){
    existing = {...existing, ...baseMeal, favorite: existing.favorite ?? false};
    await txPut("meals", existing);
  } else {
    await txPut("meals", baseMeal);
  }

  meals = await txGetAll("meals");
  return id;
}

function renderOffProduct(product, code){
  const root = document.getElementById("barcodeResult");
  if(!product){
    lastOff = { barcode: code, product: null, kcal100: null, kcalServing: null, displayName: null };
    root.innerHTML = `<div class="card"><div style="font-weight:900">Не найдено</div><div class="muted">Штрихкод: ${escapeHtml(code)}</div></div>`;
    return;
  }

  const displayName = offPickDisplayName(product);
  const quantity = product.quantity || "";
  const serving = product.serving_size || "";
  const ingredients = product.ingredients_text || product.ingredients_text_en || "";
  const nutr = product.nutriments || {};
  const {kcal100, kcalServing} = offGetKcalFromNutriments(nutr);

  lastOff = { barcode: code, product, kcal100, kcalServing, displayName };

  const kcalLine = [
    (kcal100 != null ? `<div><b>${kcal100}</b> ккал/100г</div>` : `<div class="muted">Ккал/100г: нет данных</div>`),
    (kcalServing != null ? `<div><b>${kcalServing}</b> ккал/порц</div>` : `<div class="muted">Ккал/порция: нет данных</div>`)
  ].join("");

  root.innerHTML = `
    <div class="card">
      <div style="font-weight:900">${escapeHtml(displayName)}</div>
      <div class="muted" style="margin-top:6px">
        ${quantity ? `Упаковка: ${escapeHtml(quantity)}<br>` : ""}
        ${serving ? `Порция: ${escapeHtml(serving)}<br>` : ""}
        Штрихкод: ${escapeHtml(product.code || code)}
      </div>

      <div style="margin-top:10px">${kcalLine}</div>

      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px">
        <button class="btn secondary" id="btnOffAddTo">Добавить в…</button>
        <button class="btn" id="btnOffEatSnack">Съесть (перекус)</button>
      </div>

      ${ingredients ? `<div style="margin-top:12px"><div class="muted">Ингредиенты</div><div>${escapeHtml(ingredients)}</div></div>` : `<div class="muted" style="margin-top:12px">Ингредиенты: нет данных</div>`}
    </div>
  `;

  document.getElementById("btnOffAddTo").addEventListener("click", () => {
    if(!lastOff?.product) return;

    openModal("Добавить в меню", `
      <div class="muted">Продукт</div>
      <div style="font-weight:900">${escapeHtml(lastOff.displayName || "??")}</div>

      <div style="margin-top:10px" class="row2">
        <div>
          <div class="muted">Куда добавить</div>
          <select id="offAddCat">
            <option value="breakfast">Завтрак</option>
            <option value="lunch">Обед</option>
            <option value="dinner">Ужин</option>
            <option value="treat">Вкусняшки</option>
            <option value="snack" selected>Перекусы</option>
          </select>
        </div>
        <div>
          <div class="muted">Ккал (порция)</div>
          <input id="offAddKcal" type="number" min="1" step="1" value="${escapeHtml(String((lastOff.kcalServing ?? lastOff.kcal100 ?? 1) || 1))}">
        </div>
      </div>

      <div class="muted" style="margin-top:10px">Если указаны только ккал/100г — здесь можно оставить как 100г или вручную поправить “порцию”.</div>
    `, "Добавить", false, async () => {
      const cat = String(document.getElementById("offAddCat").value || "snack");
      const kcal = Math.round(Number(document.getElementById("offAddKcal").value || 0));
      if(!kcal || kcal <= 0){ setStatus("Ккал должны быть > 0."); return false; }

      const mealId = await ensureOffMealExists({barcode:lastOff.barcode, product:lastOff.product, category: cat});
      const m = meals.find(x => x.id === mealId);
      await txPut("meals", {...m, calories: kcal, updatedAt: new Date().toISOString()});
      meals = await txGetAll("meals");

      renderFoodAll();
      updateTopTotals();
      setStatus("Добавлено в меню.");
    });
  });

  document.getElementById("btnOffEatSnack").addEventListener("click", async () => {
    if(!lastOff?.product){ setStatus("Нет данных продукта."); return; }
    const mealId = await ensureOffMealExists({barcode:lastOff.barcode, product:lastOff.product, category:"snack"});
    addMealToToday(mealId);
    await saveDraft();
    renderFoodAll();
    updateTopTotals();
    setStatus("Добавлено в “Сегодня” → Перекусы.");
  });
}

/* ---------- Scanner (ZXing) ---------- */
let zxingControls = null;
let zxingScanning = false;

async function stopScan(){
  zxingScanning = false;
  try{ zxingControls?.stop?.(); }catch(e){}
  zxingControls = null;

  const video = document.getElementById("scanVideo");
  if(video){
    try{ video.pause(); }catch(e){}
    video.srcObject = null;
  }

  document.getElementById("btnScanStart").classList.remove("hidden");
  document.getElementById("btnScanStop").classList.add("hidden");
  document.getElementById("scanCard").classList.add("hidden");
}

async function startScan(){
  const hint = document.getElementById("scanHint");
  const scanCard = document.getElementById("scanCard");
  scanCard.classList.remove("hidden");

  const video = document.getElementById("scanVideo");
  video.setAttribute("playsinline", true);

  // ZXing использует getUserMedia через constraints
  const constraints = { video: { facingMode: { ideal: "environment" } }, audio: false };

  hint.textContent = "Запрашиваю доступ к камере…";
  zxingScanning = true;

  const reader = new ZXingBrowser.BrowserMultiFormatReader();

  try{
    zxingControls = await reader.decodeFromConstraints(constraints, video, async (result, err, controls) => {
      if(!zxingScanning) return;

      if(result){
        const text = String(result.getText?.() ?? result.text ?? "").trim();
        if(text){
          hint.textContent = `Найдено: ${text}`;
          document.getElementById("barcodeInput").value = text;
          await stopScan();
          document.getElementById("btnBarcodeSearch").click();
        }
        return;
      }

      // на ошибках не стопаем — ZXing кидает NotFoundException пока не видит код
      if(err){
        // можно показать подсказку про освещение/фокус
        hint.textContent = "Сканирую… (попробуй ближе/дальше и свет)";
      }
    });

    document.getElementById("btnScanStart").classList.add("hidden");
    document.getElementById("btnScanStop").classList.remove("hidden");

    hint.textContent = "Сканирую…";
  }catch(e){
    hint.textContent = "Не удалось открыть камеру.";
    setStatus("Камера недоступна (нужен HTTPS и разрешение)." );
    await stopScan();
  }
}

/* ---------- Barcode search wiring ---------- */
function wireBarcodeSearch(){
  const input = document.getElementById("barcodeInput");
  const btn = document.getElementById("btnBarcodeSearch");
  const pasteBtn = document.getElementById("btnBarcodePaste");

  async function run(){
    const code = String(input.value || "").trim();
    if(!code){ setStatus("Введите штрихкод."); return; }
    document.getElementById("barcodeResult").innerHTML = `<div class="card"><div class="muted">Поиск…</div></div>`;
    try{
      const p = await fetchOffProductByBarcode(code);
      renderOffProduct(p, code);
      setStatus(p ? "Готово." : "Не найдено.");
    }catch(e){
      document.getElementById("barcodeResult").innerHTML = `<div class="card"><div style="font-weight:900">Ошибка</div><div class="muted">${escapeHtml(e?.message || String(e))}</div></div>`;
      setStatus("Ошибка поиска.");
    }
  }

  btn.addEventListener("click", run);
  input.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){ e.preventDefault(); run(); }
  });

  pasteBtn.addEventListener("click", async () => {
    try{
      const t = await navigator.clipboard.readText();
      if(t) input.value = t.trim();
      input.focus();
    }catch(e){
      setStatus("Не удалось прочитать буфер обмена.");
    }
  });

  document.getElementById("btnScanStart").addEventListener("click", startScan);
  document.getElementById("btnScanStop").addEventListener("click", stopScan);
}

/* ---------- Wire UI ---------- */
function wireTabs(){
  document.querySelectorAll(".tabbtn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tabbtn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.tab).classList.add("active");
    });
  });
}
function wireAddButtons(){
  document.querySelectorAll("[data-add-meal]").forEach(btn => {
    btn.addEventListener("click", () => openAddMealModal(btn.getAttribute("data-add-meal")));
  });
  document.getElementById("btnAddActivity")?.addEventListener("click", openAddActivityModal);
}
function wireDraftInputs(){
  [
    "weight","steps","notes",
    "setHeight","setAge","setSex",
    "bmrMultiplier","goalKcal","nettoMode",
    "setAppTitle","autoSaveOnNewDay","favoritesEnabled"
  ].forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;

    const handler = async () => {
      window.bmrMultiplier = Number(document.getElementById("bmrMultiplier")?.value) || window.bmrMultiplier || 1.2;
      window.goalKcal = Number(document.getElementById("goalKcal")?.value) || window.goalKcal || -400;
      window.nettoMode = String(document.getElementById("nettoMode")?.value) || window.nettoMode || "nettonobmr";
      await saveDraft();
      updateTopTotals();
    };

    el.addEventListener("input", handler);
    el.addEventListener("change", handler);

    if(id === "weight"){
      el.addEventListener("change", async () => {
        await metaSet("profile.weight", String(el.value ?? "").trim());
      });
    }
  });
}
function wireGlobalClicks(){
  document.body.addEventListener("click", async (ev) => {
    const tgl = ev.target.closest("[data-toggle-today]");
    if(tgl){
      const key = tgl.getAttribute("data-toggle-today");
      await toggleTodayCol(key);
      return;
    }

    const favMeal = ev.target.closest("[data-fav-meal]");
    if(favMeal){
      ev.preventDefault(); ev.stopPropagation();
      const id = favMeal.getAttribute("data-fav-meal");
      const m = meals.find(x => x.id === id);
      if(m){
        m.favorite = !m.favorite;
        await txPut("meals", {...m, updatedAt:new Date().toISOString()});
        meals = await txGetAll("meals");
        renderFoodAll();
        updateTopTotals();
      }
      return;
    }

    const favAct = ev.target.closest("[data-fav-act]");
    if(favAct){
      ev.preventDefault(); ev.stopPropagation();
      const id = favAct.getAttribute("data-fav-act");
      const a = activities.find(x => x.id === id);
      if(a){
        a.favorite = !a.favorite;
        await txPut("activities", {...a, updatedAt:new Date().toISOString()});
        activities = await txGetAll("activities");
        renderActivities();
        updateTopTotals();
      }
      return;
    }

    const eatBtn = ev.target.closest("[data-meal-eat]");
    if(eatBtn){
      const mealId = eatBtn.getAttribute("data-meal-eat");
      addMealToToday(mealId);
      await saveDraft();
      renderFoodAll();
      updateTopTotals();
      setStatus("Добавлено в “Сегодня”.");
      return;
    }

    const delMeal = ev.target.closest("[data-del-meal-entry]");
    if(delMeal){
      const entryId = delMeal.getAttribute("data-del-meal-entry");
      deleteMealEntry(entryId);
      await saveDraft();
      renderFoodAll();
      updateTopTotals();
      return;
    }

    const addAct = ev.target.closest("[data-act-add]");
    if(addAct){
      const id = addAct.getAttribute("data-act-add");
      const a = activities.find(x => x.id === id);
      const kph = Number(a?.kcalPerHour || 0);

      const kcalEl = document.querySelector(`#activities [data-act-kcal="${CSS.escape(id)}"]`);
      const minEl = document.querySelector(`#activities [data-act-min="${CSS.escape(id)}"]`);

      let minutes = Math.round(Number(minEl?.value || 0));
      if(!minutes){
        const kcal = Math.round(Number(kcalEl?.value || 0));
        minutes = (kcal && kph) ? Math.round(kcal * 60 / kph) : 0;
      }
      if(!minutes || minutes <= 0){
        setStatus("Введите ккал за сессию или минуты (>0)." );
        return;
      }

      todayActivityEntries.push({id, minutes});
      if(kcalEl) kcalEl.value = "";
      if(minEl) minEl.value = "";
      await saveDraft();
      renderActivities();
      updateTopTotals();
      return;
    }

    const delAct = ev.target.closest("[data-del-act-idx]");
    if(delAct){
      const idx = Number(delAct.getAttribute("data-del-act-idx"));
      todayActivityEntries.splice(idx, 1);
      await saveDraft();
      renderActivities();
      updateTopTotals();
      return;
    }
  });
}
function wireActivityInputs(){
  const activitiesTab = document.getElementById("activities");
  if(!activitiesTab) return;

  activitiesTab.addEventListener("keydown", (ev) => {
    // На мобильных клавиатурах Enter/Done часто работает как “Next”.
    const inp = ev.target?.closest?.("[data-act-min],[data-act-kcal]");
    if(!inp) return;

    const key = ev.key;
    if(key !== "Enter" && key !== "Go" && key !== "Done" && ev.keyCode !== 13) return;

    ev.preventDefault();
    ev.stopPropagation();
    ev.stopImmediatePropagation?.();

    const id = inp.getAttribute(inp.hasAttribute("data-act-min") ? "data-act-min" : "data-act-kcal");
    const btn = activitiesTab.querySelector(`[data-act-add="${CSS.escape(id)}"]`);
    if(btn) btn.click();
  }, true);

  activitiesTab.addEventListener("input", (ev) => {
    const minInp = ev.target.closest("[data-act-min]");
    const kcalInp = ev.target.closest("[data-act-kcal]");
    if(!minInp && !kcalInp) return;

    const id = (minInp || kcalInp).getAttribute(minInp ? "data-act-min" : "data-act-kcal");
    const a = activities.find(x => x.id === id);
    const kph = Number(a?.kcalPerHour || 0);
    if(!kph) return;

    const minEl = activitiesTab.querySelector(`[data-act-min="${CSS.escape(id)}"]`);
    const kcalEl = activitiesTab.querySelector(`[data-act-kcal="${CSS.escape(id)}"]`);

    if(minInp){
      const minutes = Number(minEl.value || 0);
      kcalEl.value = minutes ? String(Math.round(kph * minutes / 60)) : "";
    } else {
      const kcal = Number(kcalEl.value || 0);
      minEl.value = kcal ? String(Math.round(kcal * 60 / kph)) : "";
    }
  });
}

async function wireActions(){
  document.getElementById("btnSaveSettings").addEventListener("click", saveSettings);
  document.getElementById("btnSaveShopping").addEventListener("click", saveShopping);
  document.getElementById("btnPersist").addEventListener("click", requestPersist);

  document.getElementById("btnExport").addEventListener("click", exportBackupNow);
  document.getElementById("btnImport").addEventListener("click", async () => {
    const f = document.getElementById("importFile").files?.[0];
    if(!f){ setStatus("Выбери backup.json."); return; }
    await importBackup(f);
    await loadAll();
    setStatus("Импорт завершён.");
  });

  document.getElementById("btnResetDay").addEventListener("click", async () => {
    todayMealEntries = [];
    todayActivityEntries = [];
    document.getElementById("notes").value = "";
    document.getElementById("steps").value = "";
    await saveDraft();
    renderFoodAll();
    renderActivities();
    updateTopTotals();
    setStatus("Сброшено.");
  });

  document.getElementById("btnSaveDay").addEventListener("click", async () => {
    const date = await getAppDateISO();

    const eat = calcEatKcal();
    const burnExercise = calcBurnKcalExercise();
    const basal = calcBasalKcalPerDay();
    const burnTotal = burnExercise + basal;
    const goal = Number(window.goalKcal || 0);
    const limit = Math.round(basal + burnExercise + goal);
    const remaining = Math.round(limit - eat);

    await txPut("logs", {
      date,
      weight: document.getElementById("weight").value,
      steps: document.getElementById("steps").value,
      mealEntries: Array.from(todayMealEntries || []),
      activityEntries: Array.from(todayActivityEntries || []),
      eatCalories: eat,
      burnExerciseCalories: burnExercise,
      basalCalories: basal,
      burnCalories: burnTotal,
      netCalories: eat - burnTotal,
      goalKcal: goal,
      limitCalories: limit,
      remainingCalories: remaining,
      notes: document.getElementById("notes").value,
      updatedAt: new Date().toISOString()
    });

    // Обычный режим: сохранить запись дня и скачать backup, но не очищать текущий день.
    await exportBackupNow();
    await renderLogs();

    const dbg = await metaGet("debug.enabled");
    if(dbg){
      await advanceAppDateIfDebug();
      await refreshDateUI();

      // Очистка только в debug-режиме (когда искусственно наступают «следующие сутки»).
      todayMealEntries = [];
      todayActivityEntries = [];
      document.getElementById("notes").value = "";
      document.getElementById("steps").value = "";

      await saveDraft();
      renderFoodAll();
      renderActivities();
      updateTopTotals();
      setStatus("Сохранено. debug: дата +1.");
      return;
    }

    await refreshDateUI();
    await saveDraft();
    updateTopTotals();
    setStatus("Сохранено.");
  });

  document.getElementById("btnResetJournal").addEventListener("click", async () => {
    if(!confirm("Стереть журнал полностью?")) return;
    if(!confirm("Точно? Это необратимо.")) return;
    await txClear("logs");
    await renderLogs();
    setStatus("Журнал очищен.");
  });

  const dbgEnabled = document.getElementById("dbgEnabled");
  dbgEnabled.addEventListener("change", async () => {
    await metaSet("debug.enabled", !!dbgEnabled.checked);
    if(dbgEnabled.checked){
      const cur = await metaGet("debug.dateISO");
      if(!cur) await metaSet("debug.dateISO", isoFromDate(new Date()));
    }
    await refreshDateUI();
  });
  document.getElementById("dbgReset").addEventListener("click", async () => {
    await metaSet("debug.dateISO", isoFromDate(new Date()));
    await refreshDateUI();
    setStatus("Debug date reset.");
  });

  document.getElementById("netTile").addEventListener("click", (ev) => {
    ev.preventDefault();
    cycleNettoMode();
  });

  // stop scan when leave barcode tab
  document.querySelectorAll(".tabbtn").forEach(btn => {
    btn.addEventListener("click", async () => {
      if(btn.dataset.tab !== "barcode") await stopScan();
    });
  });
}

async function loadAll(){
  const m0 = await txGetAll("meals");
  if(!m0.length) await txBulkPut("meals", seedMealsIfEmpty(m0));
  const a0 = await txGetAll("activities");
  if(!a0.length) await txBulkPut("activities", seedActivitiesIfEmpty(a0));

  meals = await txGetAll("meals");
  activities = await txGetAll("activities");

  await loadSettings();
  await loadShopping();
  await refreshDateUI();
  await autoSaveDraftIfDateChanged();
  await loadDraft();

  renderFoodAll();
  renderActivities();
  await renderLogs();
  updateTopTotals();
}

function wireTabsAndEditors(){
  wireTabs();
  wireAddButtons();
  wireGlobalClicks();
  wireActivityInputs();
  wireModalButtons();
  wireDraftInputs();
  wireBarcodeSearch();

  installLongPress(document.body, "[data-meal-card]", el => el.getAttribute("data-meal-card"), openEditMealModal);
  installLongPress(document.getElementById("activities"), "[data-act-card]", el => el.getAttribute("data-act-card"), openEditActivityModal);
}

async function main(){
  wireTabsAndEditors();
  await wireActions();
  await loadAll();
  setStatus("Готово.");
}
main();
</script>
</body>
</html>
